{"version":3,"file":"PageInstaller-DbXFXuAa.js","sources":["../../src/components/base/PageInstaller.svelte"],"sourcesContent":["<script>\n    import { tick } from \"svelte\";\n    import { replace } from \"svelte-spa-router\";\n    import { getTokenPayload } from \"pocketbase\";\n    import ApiClient from \"@/utils/ApiClient\";\n    import { addInfoToast, addErrorToast } from \"@/stores/toasts\";\n    import { confirm } from \"@/stores/confirmation\";\n    import Field from \"@/components/base/Field.svelte\";\n    import FullPage from \"@/components/base/FullPage.svelte\";\n\n    export let params;\n\n    let email = \"\";\n    let password = \"\";\n    let passwordConfirm = \"\";\n    let isLoading = false;\n    let isUploading = false;\n\n    let emailInput;\n    let backupFileInput;\n\n    $: isBusy = isLoading || isUploading;\n\n    checkToken();\n\n    async function checkToken() {\n        if (!params?.token) {\n            return replace(\"/\");\n        }\n\n        isLoading = true;\n\n        try {\n            const payload = getTokenPayload(params?.token);\n\n            await ApiClient.collection(\"_superusers\").getOne(payload.id, {\n                requestKey: \"installer_token_check\",\n                headers: { Authorization: params?.token },\n            });\n        } catch (err) {\n            if (!err?.isAbort) {\n                addErrorToast(\"The installer token is invalid or has expired.\");\n\n                replace(\"/\");\n            }\n        }\n\n        isLoading = false;\n\n        await tick();\n\n        emailInput?.focus();\n    }\n\n    async function submit() {\n        if (isBusy) {\n            return;\n        }\n\n        isLoading = true;\n\n        try {\n            await ApiClient.collection(\"_superusers\").create(\n                {\n                    email,\n                    password,\n                    passwordConfirm,\n                },\n                {\n                    headers: { Authorization: params?.token },\n                },\n            );\n\n            await ApiClient.collection(\"_superusers\").authWithPassword(email, password);\n\n            replace(\"/\");\n        } catch (err) {\n            ApiClient.error(err);\n        }\n\n        isLoading = false;\n    }\n\n    function resetSelectedBackupFile() {\n        if (backupFileInput) {\n            backupFileInput.value = \"\";\n        }\n    }\n\n    function uploadBackupConfirm(file) {\n        if (!file) {\n            return;\n        }\n\n        confirm(\n            `Note that we don't perform validations for the uploaded backup files. Proceed with caution and only if you trust the file source.\\n\\n` +\n                `Do you really want to upload and initialize \"${file.name}\"?`,\n            () => {\n                uploadBackup(file);\n            },\n            () => {\n                resetSelectedBackupFile();\n            },\n        );\n    }\n\n    async function uploadBackup(file) {\n        if (!file || isBusy) {\n            return;\n        }\n\n        isUploading = true;\n\n        try {\n            await ApiClient.backups.upload(\n                { file: file },\n                {\n                    headers: { Authorization: params?.token },\n                },\n            );\n\n            await ApiClient.backups.restore(file.name, {\n                headers: { Authorization: params?.token },\n            });\n\n            addInfoToast(\"Please wait while extracting the uploaded archive!\");\n\n            // optimistic restore completion\n            await new Promise((r) => setTimeout(r, 2000));\n\n            replace(\"/\");\n        } catch (err) {\n            ApiClient.error(err);\n        }\n\n        resetSelectedBackupFile();\n\n        isUploading = false;\n    }\n</script>\n\n<FullPage>\n    <form class=\"block\" autocomplete=\"off\" on:submit|preventDefault={submit}>\n        <div class=\"content txt-center m-b-base\">\n            <h4>Create your first superuser account in order to continue</h4>\n        </div>\n\n        <Field class=\"form-field required\" name=\"email\" let:uniqueId>\n            <label for={uniqueId}>Email</label>\n            <input\n                bind:this={emailInput}\n                type=\"email\"\n                autocomplete=\"off\"\n                id={uniqueId}\n                disabled={isBusy}\n                bind:value={email}\n                required\n            />\n        </Field>\n\n        <Field class=\"form-field required\" name=\"password\" let:uniqueId>\n            <label for={uniqueId}>Password</label>\n            <input\n                type=\"password\"\n                autocomplete=\"new-password\"\n                minlength=\"10\"\n                id={uniqueId}\n                disabled={isBusy}\n                bind:value={password}\n                required\n            />\n            <div class=\"help-block\">Recommended at least 10 characters.</div>\n        </Field>\n\n        <Field class=\"form-field required\" name=\"passwordConfirm\" let:uniqueId>\n            <label for={uniqueId}>Password confirm</label>\n            <input\n                type=\"password\"\n                minlength=\"10\"\n                id={uniqueId}\n                disabled={isBusy}\n                bind:value={passwordConfirm}\n                required\n            />\n        </Field>\n\n        <button\n            type=\"submit\"\n            class=\"btn btn-lg btn-block btn-next\"\n            class:btn-disabled={isBusy}\n            class:btn-loading={isLoading}\n        >\n            <span class=\"txt\">Create superuser and login</span>\n            <i class=\"ri-arrow-right-line\" />\n        </button>\n    </form>\n\n    <hr />\n\n    <!-- svelte-ignore a11y-click-events-have-key-events -->\n    <!-- svelte-ignore a11y-no-noninteractive-element-interactions -->\n    <label\n        for=\"backupFileInput\"\n        class=\"btn btn-lg btn-hint btn-transparent btn-block\"\n        class:btn-disabled={isBusy}\n        class:btn-loading={isUploading}\n    >\n        <i class=\"ri-upload-cloud-line\" />\n        <span class=\"txt\">Or initialize from backup</span>\n    </label>\n    <input\n        bind:this={backupFileInput}\n        id=\"backupFileInput\"\n        type=\"file\"\n        class=\"hidden\"\n        accept=\".zip\"\n        on:change={(e) => {\n            uploadBackupConfirm(e.target?.files?.[0]);\n        }}\n    />\n</FullPage>\n"],"names":["ctx","insert","target","label","anchor","input","div","form","append","button","hr","params","$$props","email","password","passwordConfirm","isLoading","isUploading","emailInput","backupFileInput","checkToken","replace","$$invalidate","payload","getTokenPayload","ApiClient","err","addErrorToast","tick","submit","isBusy","resetSelectedBackupFile","uploadBackupConfirm","file","confirm","uploadBackup","addInfoToast","r","$$value","e","_b","_a"],"mappings":"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"}